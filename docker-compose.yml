version: "3"
services:
 postgres:
   image: akvo/akvo-lumen-db:20181023.8084497
   environment:
     - POSTGRES_PASSWORD=akvo
   volumes:
     - pg-data:/var/lib/postgresql/data
 keycloak:
   image: akvo/akvo-keycloak-dev:20181015.be5740a
 backend:
   volumes:
      - pg-data:/pg-certs:ro
   links:
      - keycloak:auth.lumen.local
      - exporter:exporter.lumen.local
   expose:
      - 3000
   environment:
     - PGSSLMODE=require
     - PGSSLKEY=/pg-data/server.key
     - PGSSLCERT=/pg-data/server.crt
     - PGPASSWORD=password # password of lumen role
   depends_on:
     - postgres
     - keycloak
     - exporter
 client:
   environment:
     - HOST_UID
     - HOST_GID
 redis:
   image: redis:3.2.9
 windshaft:
   environment:
     - PGSSLROOTCERT=/pg-certs/server.crt
     - LUMEN_ENCRYPTION_KEY=supersecret
   volumes:
      - pg-data:/pg-certs:ro
 fe-e2e-tests:
   image: akvo/akvo-lumen-e2e-test:20181016.efedbc7
   volumes:
     - ./client/e2e-test:/app
   environment:
      - LUMEN_URL=http://t1.lumen.local:3030/
      - LUMEN_USER=jerome
      - LUMEN_PASSWORD=password
   links:
      - keycloak:auth.lumen.local
      - client:t1.lumen.local
   command: "true"
 exporter:
   build: exporter
   expose:
      - 3001
volumes:
  pg-data:
