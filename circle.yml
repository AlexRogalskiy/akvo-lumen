machine:
  java:
    version: openjdk8
  node:
    version: 5.7.0
  environment:
    PROJECT_NAME: akvo-lumen
    PROD_CLUSTER_NAME: lumen
    DEV_CLUSTER_NAME: dev-cluster
    CLOUDSDK_COMPUTE_ZONE: europe-west1-d
    DEBIAN_FRONTEND: noninteractive
    LEIN_FAST_TRAMPOLINE: true
  services:
    - docker

dependencies:
  cache_directories:
    - "~/.package_cache"

  pre:
    # Keycloak
    - sudo apt-get install python-dev
    - sudo apt-get install python3-dev
    - sudo pip install --upgrade docker-compose==1.14.0
    - docker version
    - docker-compose version
    - docker-compose -p lumen-testing -f docker-compose-test.yml up keycloak postgres

  post:
    - docker version
    - docker-compose version

test:
  override:
    - docker-compose -p lumen-testing -f docker-compose-test.yml up backend
    - docker-compose -p lumen-testing -f docker-compose-test.yml up client

deployment:
  dev:
    branch: develop
    commands:
      - ./ci/dev/setup_gcloud.sh
      - ./ci/dev/build_containers.sh
      - ./ci/dev/deploy.sh

  prod:
    branch: master
    commands:
      - ./ci/prod/setup_gcloud.sh
      - ./ci/prod/build_containers.sh
      - ./ci/prod/deploy.sh
