machine:
  java:
    version: openjdk8
  node:
    version: 8.1.1
  environment:
    PROJECT_NAME: akvo-lumen
    PROD_CLUSTER_NAME: lumen
    DEV_CLUSTER_NAME: dev-cluster
    CLOUDSDK_COMPUTE_ZONE: europe-west1-d
    DEBIAN_FRONTEND: noninteractive
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker" # Docker
    - "~/.package_cache" # NPM

  override:
    - ./server.sh build:
        pwd: keycloak
    - ./server.sh run:
        pwd: keycloak

  pre:
    - if [[ -e ~/docker/keycloak.tar ]]; then docker load -i ~/docker/keycloak.tar; fi
    - docker build --rm=false -t jboss/keycloak:3.1.0.Final ./keycloak
    - mkdir -p ~/docker; docker save jboss/keycloak > ~/docker/keycloak.tar
    - mkdir -p ~/target
    # Backend
    - cp profiles.clj.template profiles.clj:
        pwd: backend
    - ./setup.sh:
        pwd: backend/provision
    - mkdir -p $HOME/.lein
    - echo '{:user {:plugins [[jonase/eastwood "0.2.3"]]}}' > $HOME/.lein/profiles.clj
    - lein deps:
        pwd: backend
    # Client
    - npm config set spin false:
        pwd: client
    - npm install -g npm-cache
    - npm-cache install:
        pwd: client

test:
  override:
    - lein do clean, check, test :all, eastwood '{:source-paths ["src" "test"]}':
        pwd: backend
    - npm run lint:
        pwd: client
    - npm test:
        pwd: client

deployment:
  dev:
    branch: develop
    commands:
      - ./ci/dev/setup_gcloud.sh
      - ./ci/dev/build_containers.sh
      - ./ci/dev/deploy.sh

  prod:
    branch: master
    commands:
      - ./ci/prod/setup_gcloud.sh
      - ./ci/prod/build_containers.sh
      - ./ci/prod/deploy.sh
