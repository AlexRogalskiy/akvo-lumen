(ns akvo.lumen.lib.visualisation.map-config
  (:require [clojure.java.jdbc :as jdbc]
            [clojure.string :as str]
            [honeysql.core :as sql]
            [hugsql.core :as hugsql]))

(hugsql/def-db-fns "akvo/lumen/lib/dataset.sql")

(defn marker-width [point-size]
  (get {"1" 8
        "2" 12
        "3" 16
        "4" 18
        "5" 24} point-size 8))

(defn cartocss
  ([]
   (cartocss "1"))
  ([point-size]
   (format "#s { marker-width: %s; marker-fill: #6ca429; marker-line-color: #888; marker-fill-opacity: 0.6; marker-allow-overlap: true;}
  " (marker-width point-size))))

(def no-dataset-sql
  "SELECT * FROM (VALUES ('label', ST_SetSRID(ST_MakePoint(4.908075,52.372189), 4326))) AS t (label, geom) LIMIT 0;")

(defn compile-sql
  [table geom-column popups]
  (let [geom-spec [geom-column "geom"]
        selects (vec (map #(let [[alias column] (first %)]
                             [column alias])
                          popups))
        [prepared-statement & args] (sql/format {:select (conj selects geom-spec)
                                                 :from [table]})
        fmt-string (str/replace prepared-statement #"\?" "%s")]
    (apply (partial format fmt-string) args)))

(defn point-colors
  [tenant-conn table-name pointColorColumn]
  (when (not (nil? pointColorColumn))
    (let [query-str (format "SELECT %s AS options, count(*) as n FROM %s GROUP BY %s LIMIT 5"
                            pointColorColumn table-name pointColorColumn)]
      (jdbc/query tenant-conn [query-str]))))

(defn map-config-layer
  [tenant-conn {:strs [datasetId popup pointSize pointColorColumn]}]
  (let [dataset (dataset-by-id tenant-conn {:id datasetId})
        table-name (:table-name dataset)
        geom-column "d1"
        point-options (point-colors tenant-conn table-name pointColorColumn)
        ;; _ (prn point-options)
        ]
    {:map-spec point-options
     :layer {"type" "mapnik"
             "options" {"cartocss" (cartocss pointSize)
                        "cartocss_version" "2.0.1"
                        "geom_column" "geom"
                        "label" "geom"
                        "interactivity" (-> (map vals popup) flatten vec)
                        "sql" (compile-sql table-name geom-column popup)
                        "srid" 4326}}}))

(def no-dataset-map-config
  {"version" "1.6.0"
   "layers" [{"type" "mapnik"
              "options" {"cartocss" (cartocss)
                         "cartocss_version" "2.0.0"
                         "geom_column" "geom"
                         "interactivity" "label"
                         "sql" no-dataset-sql
                         "srid" "4326"}}]})


(defn build [tenant-conn visualisation-spec]
  (clojure.pprint/pprint visualisation-spec)
  (if (nil? (get visualisation-spec "datasetId"))
    no-dataset-map-config
    (let [layers (into [] (map (partial map-config-layer tenant-conn)
                               (get-in visualisation-spec ["spec" "layers"])))
          {:keys [editor-spec layers]}
          (reduce (fn [{:keys [editor-spec layers]}
                       {:keys [layer map-spec]}]
                    {:editor-spec (conj editor-spec map-spec)
                     :layers (conj layers layer)})
                  {:layers []
                   :editor-spec []}
                  layers)]
      (prn "->:")
      (clojure.pprint/pprint editor-spec)
      (clojure.pprint/pprint layers)
      (assoc {"version" "1.6.0"}
             "layers" layers))))
